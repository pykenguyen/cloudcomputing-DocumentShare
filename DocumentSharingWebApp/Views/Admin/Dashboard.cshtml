@model DocumentSharingWebApp.ViewModels.AdminDashboardVM
@using System.Text.Json

@{
    ViewBag.Title = "Bảng điều khiển";
    var M = Model ?? new DocumentSharingWebApp.ViewModels.AdminDashboardVM();
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-speedometer2"></i> Bảng điều khiển</h4>
    <div class="btn-group">
        <a asp-action="ManageDocuments" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-text"></i> Tài liệu</a>
        <a asp-action="ManageUsers" class="btn btn-outline-primary btn-sm"><i class="bi bi-people"></i> Người dùng</a>
        <a asp-action="ManageReports" class="btn btn-outline-primary btn-sm"><i class="bi bi-flag"></i> Báo lỗi</a>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Người dùng</div><div class="fs-4 fw-bold">@M.TotalUsers</div><div class="small text-success">+ @M.NewUsersToday hôm nay</div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Tài liệu</div><div class="fs-4 fw-bold">@M.TotalDocuments</div><div class="small"><span class="badge text-bg-warning">@M.PendingDocuments chờ duyệt</span></div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Tải xuống (tổng)</div><div class="fs-4 fw-bold">@M.TotalDownloads</div><div class="small text-muted">Đếm mọi lượt tải</div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body"><div class="text-muted">Xu chi (tháng này)</div><div class="fs-4 fw-bold">@M.CoinsSpentThisMonth.ToString("0")</div><div class="small text-muted">Chỉ tính các giao dịch mua</div></div></div></div>
</div>

<div class="row g-3 mt-1">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header"><i class="bi bi-graph-up"></i> Upload 7 ngày gần đây</div>
            <div class="card-body"><canvas id="uploadsChart" height="100"></canvas></div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-bar-chart"></i> Top danh mục</div>
            <ul class="list-group list-group-flush">
                @if (M.TopCategories?.Any() == true)
                {
                    foreach (var c in M.TopCategories)
                    {
                        <li class="list-group-item d-flex justify-content-between"><span>@c.Name</span><span class="badge text-bg-primary">@c.Count</span></li>
                    }
                }
                else
                {
                    <li class="list-group-item text-muted">Chưa có dữ liệu</li>
                }
            </ul>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-hourglass-split"></i> Tài liệu chờ duyệt gần đây</div>
            <div class="list-group list-group-flush">
                @if (M.PendingLatest?.Any() == true)
                {
                    foreach (var d in M.PendingLatest)
                    {
                        <a asp-action="ViewDocument" asp-route-id="@d.Id" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between">
                                <div><div class="fw-semibold">@d.Title</div><div class="small text-muted">@d.Uploader · @d.Category</div></div>
                                <small class="text-muted">@d.UploadedAt?.ToString("dd/MM HH:mm")</small>
                            </div>
                        </a>
                    }
                }
                else
                {

                    <div class="list-group-item text-muted">Không có tài liệu nào.</div>
                }
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-flag"></i> Báo lỗi mới nhất</div>
            <div class="list-group list-group-flush">
                @if (M.ReportsLatest?.Any() == true)
                {
                    foreach (var r in M.ReportsLatest)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div><div class="fw-semibold">@r.DocTitle</div><div class="small text-muted">Từ: @r.Reporter · Lý do: @r.Reason</div></div>
                                <small class="text-muted">@r.At?.ToString("dd/MM HH:mm") · @r.Status</small>
                            </div>
                        </div>
                    }
                }
                else
                {

                    <div class="list-group-item text-muted">Không có báo lỗi nào.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- JSON an toàn, không lẫn Razor trong JS -->
    <script id="uploadsChartData" type="application/json">
        @Html.Raw(JsonSerializer.Serialize(new {
            labels = M.Last7DaysLabels ?? new List<string>(),
                values = M.Last7DaysUploads ?? new List<int>()
        }))
</script>

<script src="~/js/admin-dashboard.js"></script>
}
