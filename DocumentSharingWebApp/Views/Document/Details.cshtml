@model DocumentSharingWebApp.Models.Document
@{
    ViewBag.Title = Model.Title;

    var price = (decimal)(ViewBag.Price ?? (Model.DownloadCost ?? 0m));
    var isAdminDoc = Model.Uploader?.Role?.Equals("Admin", StringComparison.OrdinalIgnoreCase) == true;
    var isFree = !isAdminDoc || price <= 0m;

    var hasPurchased = (bool)(ViewBag.HasPurchased ?? false);
    decimal? balance = ViewBag.Balance is null ? (decimal?)null : Convert.ToDecimal(ViewBag.Balance);
    bool isGuest = !(User?.Identity?.IsAuthenticated ?? false);

    var uploaderName = Model.IsGuestUpload
        ? (!string.IsNullOrWhiteSpace(Model.GuestName) ? Model.GuestName : "Khách")
        : (Model.Uploader?.Username ?? "—");
}
<div class="page-title"><i class="bi bi-file-earmark-text"></i><h2 class="mb-0">@Model.Title</h2></div>

<div class="ds-container ds-2col">
    <div>
        <div class="card mb-3">
            <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center">
                <img src="@Url.Action("Thumb", "Document", new { id = Model.DocumentId, w = 2000 })"
                     alt="Xem nhanh" class="img-fluid" style="object-fit:contain; max-height:100vh;">
            </div>
        </div>

        <div class="card card-info card-outline mb-3">
            <div class="card-header fw-semibold"><i class="bi bi-chat-dots"></i> Bình luận</div>
            <div class="card-body">
                @if (TempData["CommentError"] != null)
                {
                    <div class="alert alert-danger">@TempData["CommentError"]</div>
                }

                @if (!isGuest)
                {
                    <form asp-action="PostComment" method="post" class="mb-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="documentId" value="@Model.DocumentId" />
                        <div class="input-group">
                            <textarea name="content" class="form-control" rows="2" placeholder="Nhập bình luận..."></textarea>
                            <button type="submit" class="btn btn-primary">Gửi</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-soft mb-3">
                        Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để bình luận.
                    </div>
                }

                @if (Model.Comments != null && Model.Comments.Any())
                {
                    <ul class="list-group">
                        @foreach (var c in Model.Comments.OrderByDescending(c => c.CommentDate))
                        {
                            <li class="list-group-item">
                                <strong>@c.User?.Username</strong>
                                <small class="text-muted">(@c.CommentDate?.ToString("dd/MM/yyyy HH:mm"))</small>
                                <div>@c.Content</div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">Chưa có bình luận nào.</div>
                }
            </div>
        </div>

        <div class="card card-danger card-outline">
            <div class="card-header fw-semibold"><i class="bi bi-exclamation-triangle"></i> Báo lỗi</div>
            <div class="card-body">
                @if (TempData["ReportError"] != null)
                {
                    <div class="alert alert-danger">@TempData["ReportError"]</div>
                }
                @if (TempData["ReportSuccess"] != null)
                {
                    <div class="alert alert-success">@TempData["ReportSuccess"]</div>
                }

                <form asp-action="Report" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="documentId" value="@Model.DocumentId" />
                    <div class="mb-2">
                        <textarea name="reason" class="form-control" rows="3" placeholder="Nhập lý do báo lỗi..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-send"></i> Gửi báo lỗi</button>
                </form>
            </div>
        </div>
    </div>

    <aside class="sticky-actions">
        <div class="card">
            <div class="card-body">
                <div class="mb-2">
                    @if (isFree)
                    {
                        <span class="badge badge-free">Miễn phí</span>
                    }
                    else
                    {

                        <span class="badge badge-paid">@price.ToString("0") xu</span>
                    }
                </div>

                @if (!isFree && isGuest)
                {
                    <div class="alert alert-info py-2 mb-3">
                        Tài liệu có phí. Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để mua & tải.
                    </div>
                }

                @if (!isGuest)
                {
                    <div class="mb-3 text-muted">
                        <i class="bi bi-wallet2"></i> Số dư:
                        <strong>@(balance?.ToString("0") ?? "0") xu</strong>
                        @if (hasPurchased)
                        {
                            <span class="ms-2 badge bg-primary">Đã mua</span>
                        }
                    </div>
                }

                <div class="meta mb-3">
                    <div class="text-muted">Mô tả</div>
                    <div>@(string.IsNullOrWhiteSpace(Model.Description) ? "—" : Model.Description)</div>

                    <div class="text-muted">Danh mục</div>
                    <div>@(Model.Category?.CategoryName ?? "—")</div>

                    <div class="text-muted">Người tải lên</div>
                    <div>@uploaderName</div>

                    <div class="text-muted">Ngày tải lên</div>
                    <div>@Model.UploadDate?.ToString("dd/MM/yyyy HH:mm")</div>

                    <div class="text-muted">Lượt tải</div>
                    <div>@(Model.DownloadCount ?? 0)</div>

                    <div class="text-muted">Lượt thích</div>
                    <div>@(ViewBag.LikeCount ?? 0)</div>
                </div>

                <div class="d-grid gap-2 mb-2">
                    @if (isFree)
                    {
                        <a asp-action="Download" asp-route-id="@Model.DocumentId" class="btn btn-success">
                            <i class="bi bi-download"></i> Tải xuống (miễn phí)
                        </a>
                    }
                    else
                    {
                        if (isGuest)
                        {
                            <a asp-controller="Account" asp-action="Login" class="btn btn-secondary">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để mua & tải
                            </a>
                        }
                        else if (hasPurchased)
                        {
                            <a asp-action="Download" asp-route-id="@Model.DocumentId" class="btn btn-success">
                                <i class="bi bi-download"></i> Tải lại (đã mua)
                            </a>
                        }
                        else
                        {
                            <a asp-action="Download" asp-route-id="@Model.DocumentId" class="btn btn-primary">
                                <i class="bi bi-cart-check"></i> Mua & tải (@price.ToString("0") xu)
                            </a>
                        }

                        <a asp-action="Wallet" class="btn btn-outline-primary">
                            <i class="bi bi-coin"></i> Ví xu
                        </a>
                    }
                </div>

                <div>
                    @if (User?.Identity?.IsAuthenticated ?? false)
                    {
                        <form asp-action="ToggleLike" asp-route-id="@Model.DocumentId" method="post" class="d-grid">
                            @Html.AntiForgeryToken()
                            @if (ViewBag.UserLiked == true)
                            {
                                <button type="submit" class="btn btn-warning"><i class="bi bi-hand-thumbs-down"></i> Bỏ thích</button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-primary"><i class="bi bi-hand-thumbs-up"></i> Thích</button>
                            }
                        </form>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để thích
                        </a>
                    }
                </div>

                @if (TempData["DownloadError"] != null)
                {
                    <div class="alert alert-danger mt-3">@TempData["DownloadError"]</div>
                }
            </div>
        </div>
    </aside>
</div>
